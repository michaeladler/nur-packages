name: update packages

# Controls when the action will run.
on:
  workflow_dispatch:
  schedule:
    # NB: jobs may be delayed a couple of hours
    - cron:  '0 0 * * *'

jobs:

  update-all:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      - uses: cachix/install-nix-action@v18
        with:
          nix_path: nixpkgs=channel:nixpkgs-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}

      - uses: cachix/cachix-action@v12
        with:
          name: nur-packages
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'

      - name: update
        run: |
          df -h
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          df -h

          mkdir -p ~/.config/nix ~/.config/nixpkgs/overlays
          [ -n "${GITHUB_TOKEN:-}" ] || {
            echo "GITHUB_TOKEN not set"
            exit 1
          }
          echo "access-tokens = github.com=$GITHUB_TOKEN" >>~/.config/nix/nix.conf

          nix-shell \
            --command "just update-all" \
            -p nixUnstable update-nix-fetchgit just
          nix-shell \
            --command "nix --experimental-features 'nix-command flakes' flake check" \
            -p nixUnstable
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: build
        run: |
          nix-shell \
            --command "just build-all" \
            -p nixUnstable just

      - name: Commit & Push changes
        uses: benkaiser/rebase-commit-push@v1.1
        with:
          message: 'chore: update packages'
          rebase: true
